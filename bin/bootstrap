#!/usr/bin/env bash

{
  export DOT_DIR="$HOME/.local/share/linux-config"
  LOG_ROOT="${LINUX_CONFIG_LOG_DIR:-$HOME/.linux-config-logs}"
  LOG_TIMESTAMP="$(date '+%Y%m%d-%H%M%S')"
  LOG_FILE="${LOG_ROOT}/bootstrap-${LOG_TIMESTAMP}.log"
  LOG_AVAILABLE=0
  LOG_NOTICE_SHOWN=0

  init_log_file() {
    if [ "$LOG_AVAILABLE" -eq 1 ]; then
      return
    fi

    if mkdir -p "$LOG_ROOT" && : >"$LOG_FILE"; then
      LOG_AVAILABLE=1
    elif [ "$LOG_NOTICE_SHOWN" -eq 0 ]; then
      echo -e "\033[0;33m! Unable to write bootstrap logs to $LOG_ROOT. File logging disabled.\033[0m" >&2
      LOG_NOTICE_SHOWN=1
    fi
  }

  has_cmd() {
    command -v "$1" >/dev/null 2>&1
  }

  dir_exists() {
    [ -d "$1" ]
  }

  is_trixie() {
    [ -f /etc/os-release ] && grep -qi 'trixie' /etc/os-release 2>/dev/null
  }

  is_questing() {
    [ -f /etc/os-release ] && grep -qi 'questing' /etc/os-release 2>/dev/null
  }

  is_fedora() {
    [ -f /etc/redhat-release ] && grep -q -i 'Fedora' /etc/redhat-release
  }

  is_linux() {
    [ "$(uname -s)" = "Linux" ]
  }

  is_tw() {
    [ -f /etc/os-release ] && grep -q 'Tumbleweed' /etc/os-release 2>/dev/null
  }

  is_mac() {
    [ "$(uname -s)" = "Darwin" ]
  }

  is_arch() {
    [ -f /etc/os-release ] && grep -q 'Arch Linux' /etc/os-release 2>/dev/null
  }

  is_pikaos() {
    [ -f /etc/os-release ] && grep -q 'pika' /etc/os-release 2>/dev/null
  }

  is_apt() {
    is_trixie || is_questing || is_pikaos
  }

  is_ubuntu() {
    [ -f /etc/os-release ] && grep -q 'Ubuntu' /etc/os-release 2>/dev/null
  }

  prompt_yn() {
    local prompt="$1"
    local response
    while true; do
      printf '\033[0;36m? %s\033[0m \033[0;33m[y/N]\033[0m ' "$prompt"
      read -r response
      case "$response" in
      [yY][eE][sS] | [yY])
        return 0
        ;;
      [nN][oO] | [nN] | "")
        return 1
        ;;
      *)
        warn "Please answer yes or no."
        ;;
      esac
    done
  }

  log_message() {
    local level="$1"
    local color="$2"
    local symbol="$3"
    local msg="$4"
    local timestamp
    timestamp="$(date '+%Y-%m-%d %H:%M:%S')"

    echo -e "${color}${symbol} ${msg}\033[0m"
    init_log_file
    if [ "$LOG_AVAILABLE" -eq 1 ]; then
      printf '%s [%s] %s\n' "$timestamp" "$level" "$msg" >>"$LOG_FILE"
    fi
  }

  log() {
    log_message "INFO" "\033[0;32m" "→" "$1"
  }

  warn() {
    log_message "WARN" "\033[0;33m" "!" "$1"
  }

  error() {
    log_message "ERROR" "\033[0;31m" "✗" "$1"
  }

  die() {
    error "$1"
    exit 1
  }

  keep_sudo_alive() {
    log "Keeping sudo alive"
    sudo -v
    while true; do
      sudo -n true
      sleep 60
      kill -0 "$$" || exit
    done 2>/dev/null &
  }

  paru_install() {
    has_cmd paru && return 0
    log "Installing paru"

    si base-devel
    rm -rf /tmp/paru
    git clone https://aur.archlinux.org/paru.git /tmp/paru && cd /tmp/paru && makepkg --syncdeps --noconfirm --install && cd - && frm /tmp/paru
  }

  update_packages() {
    log "Updating packages"

    if is_fedora; then
      sudo dnf update -y
    elif is_trixie || is_questing; then
      sudo apt update && sudo apt upgrade -y
    elif is_pikaos; then
      pikman update && pikman upgrade
    elif is_tw; then
      sudo zypper refresh && sudo zypper update
    elif is_arch; then
      sudo pacman -Syu
    else
      error "OS not supported. Quitting."
      exit 1
    fi
  }

  si() {
    log "Installing $*"
    if is_fedora; then
      sudo dnf install -y "$@"
    elif is_trixie || is_questing; then
      sudo apt install -y "$@"
    elif is_pikaos; then
      pikman install "$@"
    elif is_tw; then
      sudo zypper --non-interactive --quiet install --auto-agree-with-licenses "$@"
    elif is_arch; then
      sudo pacman -S --quiet --noconfirm "$@"
    elif is_mac; then
      brew install "$@"
    else
      error "OS not supported. Not installing $*."
      return 1
    fi
  }

  brew_install() {
    has_cmd brew && return

    log "Installing brew"
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"

    has_cmd topgrade || brew install topgrade

    is_mac && {
      brew install rclone rsync stow tar tmux trash-cli tree unzip zstd
      brew install imagemagick starship nushell
    }
  }

  dotfiles_clone() {
    local repo_dir="$DOT_DIR"
    local repo_url="https://github.com/pervezfunctor/linux-config.git"

    dir_exists "$repo_dir" || {
      cd || {
        error "Failed to change to home directory"
        return 1
      }

      log "Cloning dotfiles"
      git clone --depth 1 "$repo_url" "$repo_dir" || {
        error "Failed to clone dotfiles"
        return 1
      }
      return 0
    }

    cd "$repo_dir" || {
      error "Failed to change to dotfiles directory"
      return 1
    }

    git rev-parse --is-inside-work-tree >/dev/null 2>&1 || {
      error "$repo_dir is not a git repository"
      return 1
    }

    local repo_status
    repo_status=$(git status --porcelain=v1 2>/dev/null) || {
      error "Unable to determine repository status"
      return 1
    }

    if [ -z "$repo_status" ]; then
      log "Dotfiles repo clean. Pulling latest changes"
      if git pull --rebase --stat; then
        log "Dotfiles updated"
        return 0
      fi

      warn "git pull --rebase failed. Attempting to abort rebase"
      git rebase --abort >/dev/null 2>&1 || true
      return 1
    fi

    log "Dotfiles repo has local changes. Stashing before pull"
    local stash_label
    stash_label="bootstrap-autostash-$(date +%s)"
    git stash push --include-untracked --message "$stash_label" >/dev/null || {
      error "Failed to stash local changes"
      return 1
    }

    local stash_ref
    stash_ref=$(git stash list | head -n1 | cut -d: -f1)
    if [ -z "$stash_ref" ]; then
      error "Unable to determine stash reference"
      return 1
    fi

    if git pull --rebase --stat; then
      log "Pull succeeded. Restoring local changes"
      if git stash apply "$stash_ref" >/dev/null 2>&1; then
        git stash drop "$stash_ref" >/dev/null 2>&1 || true
        log "Local changes restored"
        return 0
      fi

      warn "Failed to reapply stashed changes. Stash $stash_ref preserved"
      return 1
    fi

    warn "git pull --rebase failed with local changes. Restoring state"
    git rebase --abort >/dev/null 2>&1 || true
    if git stash apply "$stash_ref" >/dev/null 2>&1; then
      git stash drop "$stash_ref" >/dev/null 2>&1 || true
      warn "Reapplied stashed changes after pull failure"
    else
      warn "Failed to reapply stashed changes after pull failure. Use git stash list"
    fi
    return 1
  }

  bootstrap() {
    export PATH="${DOT_DIR}/bin:/home/linuxbrew/.linuxbrew/bin:$HOME/.pixi/bin:$HOME/bin:$HOME/.local/bin:$HOME/.local/share/pnpm:$PATH"

    keep_sudo_alive

    if is_mac; then
      xcode-select --install
      /usr/sbin/softwareupdate --install-rosetta --agree-to-license
      brew_install
    fi

    is_fedora || is_trixie || is_questing || is_tw || is_arch || is_pikaos || {
      error "Only  Fedora, Questing, Tumbeweed, Arch, PikaOS supported. Quitting."
      exit 1
    }

    log "Installing required packages..."
    si git stow trash-cli whiptail unzip

    dotfiles_clone
  }
  if [ "${BASH_SOURCE[0]}" == "${0}" ] || [ -n "$1" ]; then
    bootstrap "$@"

    if [ "$1" == "shell" ] || [ "$1" == "all" ]; then
      "$DOT_DIR/bin/setup-shell"
    fi

    is_mac && exit 0

    if [ "$1" == "desktop" ] || [ "$1" == "all" ]; then
      "$DOT_DIR/bin/setup-desktop" && exit 0
    fi
  fi
}
