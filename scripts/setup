#!/usr/bin/env bash

has_cmd() {
    command -v "$1" >/dev/null 2>&1
}

dir_exists() {
    [ -d "$1" ]
}

is_pikaos() {
    # shellcheck disable=SC1091
    [ -f /etc/os-release ] && grep -q 'pika' /etc/os-release 2>/dev/null
}

is_trixie() {
    [ -f /etc/os-release ] && grep -qi 'trixie' /etc/os-release 2>/dev/null
}

is_questing() {
    [ -f /etc/os-release ] && grep -qi 'questing' /etc/os-release 2>/dev/null
}

is_fedora() {
    [ -f /etc/redhat-release ] && grep -q -i 'Fedora' /etc/redhat-release
}

prompt_yn() {
    local prompt="$1"
    local response
    while true; do
        read -rp "\033[0;36m? $prompt\033[0m \033[0;33m[y/N]\033[0m " response
        case "$response" in
        [yY][eE][sS] | [yY])
            return 0
            ;;
        [nN][oO] | [nN] | "")
            return 1
            ;;
        *)
            warn "Please answer yes or no."
            ;;
        esac
    done
}

log() {
    local msg="$1"
    echo -e "\033[0;32m→ $msg\033[0m"
    echo "→ $msg" >>"${LOG_FILE:-$HOME/.niri-config-log.log}"
    sleep 0.5
}

warn() {
    local msg="$1"
    echo -e "\033[0;33m! $msg\033[0m"
    echo "! $msg" >>"${LOG_FILE:-$HOME/.niri-config-warn.log}"
    sleep 0.2
}

error() {
    local msg="$1"
    echo -e "\033[0;31m✗ $msg\033[0m"
    echo "✗ $msg" >>"${LOG_FILE:-$HOME/.niri-config-error.log}"
    sleep 0.2
}

die() {
    error "$1"
    exit 1
}

keep_sudo_alive() {
    sudo -v
    while true; do
        sudo -n true
        sleep 60
        kill -0 "$$" || exit
    done 2>/dev/null &
}

snapper_setup() {
    if sudo snapper list-configs | grep -q "/"; then
        log "Snapper is already setup for /"
        return
    fi

    sudo snapper create-config /
    sudo mkdir -p /var/lib/refind-btrfs
    sudo chmod 755 /var/lib/refind-btrfs
    sudo systemctl enable refind-btrfs --now
}

brew_install() {
    has_cmd brew && return

    log "Installing brew"
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"

    brew tap ublue-os/tap
    brew install --cask font-jetbrains-mono-nerd-font font-fontawesome
}

mangowc_install() {
    log "Installing mangowc"

    if is_pikaos; then
        pikman install mangowc
    elif is_fedora && prompt_yn "need terra repository for installing mango. This is NOT stable. Still enable it?"; then
        sudo dnf install --nogpgcheck --repofrompath 'terra,https://repos.fyralabs.com/terra$releasever' terra-release
        sudo dnf install -y mangowc
    else
        error "Unsupported OS. Not installing mangowc."
        return 1
    fi
}

incus_setup() {
    log "Setting up incus"
    sudo usermod -aG incus "$USER"
    sudo usermod -aG incus-admin "$USER"
    sudo systemctl enable --now incus.socket
    sudo incus admin init --minimal
}

flatpaks_install() {
    flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo --user

    local -a flatpaks=(
        com.github.tchx84.Flatseal
        sh.loft.devpod
        org.gnome.Papers
        io.github.kolunmi.Bazaar
    )

    log "Installing flatpaks(vscode etc)"
    for pkg in "${flatpaks[@]}"; do
        flatpak --user install -y flathub "$pkg"
    done
}

dms_setup() {
    mkdir -p ~/.config/niri/dms ~/.config/mango/dms
    touch ~/.config/niri/dms/{alttab,colors,layout,wpblur,binds,cursor,outputs}.kdl
    touch ~/.config/mango/dms/{alttab,colors,layout,wpblur,binds,cursor,outputs}.kdl
}

update_packages() {
    log "Updating packages"

    if is_pikaos; then
        pikman update && pikman upgrade
    elif is_fedora; then
        sudo dnf update -y
    elif is_trixie || is_questing; then
        sudo apt update && sudo apt upgrade -y
    else
        error "OS not supported. Quitting."
        exit 1
    fi
}

niri_install() {
    has_cmd niri && {
        log "niri is already installed"
        return
    }

    if is_pikaos; then
        pikman install pika-niri-desktop-minimal pika-niri-settings
    elif is_fedora; then
        sudo dnf install -y niri
    elif is_questing; then
        sudo add-apt-repository ppa:avengemedia/danklinux
        sudo add-apt-repository ppa:avengemedia/dms
        sudo apt install -y niri dms
    elif is_fedora; then
        sudo dnf copr enable avengemedia/dms
    else
        error "OS not supported. Not installing niri."
        return 1
    fi
    systemctl --user add-wants niri.service dms || true
}

si() {
    if is_fedora; then
        sudo apt install -y "$@"
    elif is_trixie || is_questing; then
        sudo apt install -y "$@"
    elif is_pikaos; then
        pikman install "$@"
    else
        error "OS not supported. Not installing $*."
        return 1
    fi
}

virt_install() {
    local -a packages=(
        podman
        distrobox
        virt-manager
        incus
    )
    si "${packages[@]}"
}

system_install() {
    update_packages

    local -a common_pkgs=(
        cmake
        flatpak
        g++
        gcc
        git
        gnome-keyring
        luarocks
        make
        micro
        mpv
        pass
        pipx
        plocate
        qt5ct
        qt6ct
        rclone
        rsync
        snapper
        tar
        tmux
        trash-cli
        tree
        unzip
        zsh
        zstd
    )
    local -a apt_pkgs=(
        libsecret-tools
        bibata-cursor-theme
        imagemagick
        starship
    )
    local -a pika_pkgs=(
        snapper-gui
        nushell
        pika-refind-btrfs-hooks
        refind-btrfs
        zig
    )
    local -a fedora_pkgs=(
        sddm
        sddm-themes
        nu
    )

    if is_trixie || is_pikaos || is_questing; then
        log "Installing system packages"
        si "${common_pkgs[@]}" "${apt_pkgs[@]}"
    fi

    if is_pikaos; then
        si "${pika_pkgs[@]}"
        snapper_setup
    elif is_fedora; then
        sudo dnf install -y "${common_pkgs[@]}" "${fedora_pkgs[@]}"
    fi
    pipx install pywal pywalfox

    incus_setup
    log "Updating locate database, this may take a while..."
    sudo updatedb
}

pixi_install() {
    brew install pixi

    local -a pixi_pkgs=(
        bash-language-server
        tectonic
        fd
        bat
        bottom
        carapace
        direnv
        duf
        eza
        fzf
        gdu
        gh
        go-gum
        go-shfmt
        jq
        just
        lazygit
        mask
        ripgrep
        shellcheck
        tealdeer
        television
        xh
        yazi
        zoxide
    )

    pixi global install "${pixi_pkgs[@]}"
    has_cmd starship || pixi global install starship
    ~/.pixi/bin/tldr --update
}

shell_install() {
    brew_install
    pixi_install
}

emacs_install() {
    log "Installing emacs"
    if has_cmd pikman; then
        pikman --arch install emacs
    else
        si emacs
    fi
    git clone --depth 1 https://github.com/doomemacs/doomemacs ~/.config/emacs
    ∙ ~/.config/emacs/bin/doom install
}

rust_install() {
    has_cmd rustup && {
        log "rustup is already installed"
        return
    }

    curl --proto '=https' --tlsv1.2 -fsSL https://sh.rustup.rs | sh
}

nushell_setup() {
    is_pikaos && return

    log "Setting up nushell"
    grep -q "nushell" /etc/shells || {
        echo "/usr/bin/nu" | sudo tee -a /etc/shells
    }
}

devpod_install() {
    has_cmd devpod && {
        log "devpod is already installed"
        return
    }

    log "Installing devpod"
    local devpod_tmp
    devpod_tmp=$(mktemp)
    curl -L -o "$devpod_tmp" "https://github.com/loft-sh/devpod/releases/latest/download/devpod-linux-amd64" &&
        chmod +x "$devpod_tmp" &&
        mv "$devpod_tmp" ~/.local/bin/devpod
    rm -f "$devpod_tmp"
}

astro_install() {
    if dir_exists ~/.config/nvim; then
        prompt_yn "Found existing nvim config. Do you want to trash and replace with AstroNvim?" || return 0
    fi

    trash ~/.config/nvim.bak || true
    mv ~/.config/nvim ~/.config/nvim.bak 2>/dev/null || true
    mkdir ~/.config/nvim 2>/dev/null || true
    mv ~/.local/share/nvim ~/.local/share/nvim.bak 2>/dev/null || true
    mv ~/.local/state/nvim ~/.local/state/nvim.bak 2>/dev/null || true
    mv ~/.cache/nvim ~/.cache/nvim.bak 2>/dev/null || true
    git clone --depth 1 https://github.com/AstroNvim/template ~/.config/nvim
    rm -rf ~/.config/nvim/.git
}

zshrc_setup() {
    log "Setting zsh as default shell"
    chsh -s "$(which zsh)"
}

bashrc_setup() {
    log "Setting up bashrc"
    grep -q "chezmoi/shellrc" ~/.bashrc || {
        echo "source ~/.local/share/chezmoi/shellrc" >>~/.bashrc
    }
}

dotfiles_install() {
    cd || {
        error "Failed to change to home directory"
        return
    }

    log "Setting up dotfiles with chezmoi"
    sh -c "$(curl -fsLS get.chezmoi.io/lb)" -- init --apply https://github.com/pervezfunctor/niri-config.git

    zshrc_setup
    bashrc_setup
    nushell_setup
    astro_install
    dms_setup
}

devtools_install() {
    has_cmd mise || {
        curl https://mise.run | sh
    }

    brew install uv mise neovim
    brew install --cask visual-studio-code-linux

    local -a extensions=(
        hverlin.mise-vscode
        jdinhlife.gruvbox
        mads-hartmann.bash-ide-vscode
        TheNuProjectContributors.vscode-nushell-lang
        timonwong.shellcheck
    )

    log "Installing vscode extensions"
    for ext in "${extensions[@]}"; do
        log "Installing $ext"
        code --install-extension "$ext"
    done

    eval "$(~/.local/bin/mise activate bash)"
    mise use -g node@latest pnpm
    pnpm setup

    local -a npm_pkgs=(
        @mermaid-js/mermaid-cli
        @google/gemini-cli
        opencode-ai
    )
    for pkg in "${npm_pkgs[@]}"; do
        log "Installing $pkg"
        pnpm install -g "$pkg"
    done

    dir_exists ~/jupyter-lab || {
        mkdir -p ~/jupyter-lab
        cd ~/jupyter-lab || {
            error "Failed to change to jupyter-lab directory"
            return
        }
        uv venv --seed
        uv pip install pydantic
        uv pip install jupyterlab
    }

    has_cmd claude || curl -fsSL https://claude.ai/install.sh | bash
    devpod_install
    rust_install
}

motltbot_install() {
    curl -fsSL https://molt.bot/install.sh | bash
}

zed_install() {
    has_cmd zed && {
        log "zed is already installed"
        return
    }

    log "Installing zed"
    curl -f https://zed.dev/install.sh | sh
}

whiptail_choices() {
    local -a whiptail_items=(
        "system" "Install system packages" "on"
        "shell" "Install shell packages" "on"
        "devtools" "Install devtools(vscode, mise, node etc)" "on"
        "dotfiles" "Setup dotfiles with chezmoi" "on"
        "flatpaks" "Install flatpaks" "on"
        "virt" "Install virtualization packages" "off"
        "zed" "Install zed" "off"
        "emacs" "Setup emacs" "off"
    )

    if is_fedora || is_questing; then
        whiptail_items+=("niri" "Install niri" "off")
    fi
    if is_fedora || is_pikaos; then
        whiptail_items+=("mangowc" "Install mangowc" "off")
    fi

    local selected_output
    selected_output=$(whiptail --checklist "Select tasks to execute:" 25 60 19 "${whiptail_items[@]}" 3>&1 1>&2 2>&3)

    local exit_code=$?
    if [ $exit_code -ne 0 ]; then
        warn "Setup cancelled."
        return 1
    fi

    local -a selected_tasks=()
    if [ -n "$selected_output" ]; then
        # Parse space-separated quoted items from whiptail output
        read -ra selected_tasks <<<"$selected_output"
    fi

    if [ ${#selected_tasks[@]} -eq 0 ]; then
        log "No tasks selected."
        return 0
    fi

    for task in "${selected_tasks[@]}"; do
        task=${task//\"/}
        log "Executing: $task"
        "${task}_install"
    done
}

prompts() {
    prompt_yn "Do you want to install system packages?" && system_install
    prompt_yn "Do you want to install shell packages?" && shell_install
    prompt_yn "Do you want to setup devtools?" && devtools_install
    prompt_yn "Do you want to setup dotfiles with chezmoi?" && dotfiles_install
    prompt_yn "Do you want to install flatpaks?" && flatpaks_install
    prompt_yn "Do you want to install virtualization packages?" && virt_install
    prompt_yn "Do you want to install zed?" && zed_install
    prompt_yn "Do you want to setup emacs?" && emacs_install

    if is_fedora || is_questing; then
        prompt_yn "Do you want to install niri?" && niri_install
    fi
    if is_fedora || is_pikaos; then
        prompt_yn "Do you want to setup mangowc?" && mangowc_install
    fi
}

main() {
    rm -f "$HOME"/.niri-config-*.log

    export LOG_FILE="${HOME}/.setup.log"
    : >"$LOG_FILE" # Clear log file
    keep_sudo_alive

    is_pikaos || is_fedora || {
        error "This script is only meant to be run on PikaOS/Fedora"
        return 1
    }

    export PATH="/home/linuxbrew/.linuxbrew/bin:$HOME/.pixi/bin:$HOME/bin:$HOME/.local/bin:$PATH"

    mkdir -p ~/Pictures/Screenshots

    if command -v whiptail >/dev/null 2>&1; then
        whiptail_choices || return 1
        return 0
    fi

    prompts
}

main "$@"
