#!/usr/bin/env bash

has_cmd() {
    command -v "$1" >/dev/null 2>&1
}

dir_exists() {
    [ -d "$1" ]
}

is_pikaos() {
    # shellcheck disable=SC1091
    . /etc/os-release && [ "$ID" = "pika" ]
}

is_fedora() {
    # shellcheck disable=SC1091
    . /etc/os-release && [ "$ID" = "fedora" ]
}

prompt_yn() {
    local prompt="$1"
    local response
    while true; do
        read -rp "\033[0;36m? $prompt\033[0m \033[0;33m[y/N]\033[0m " response
        case "$response" in
        [yY][eE][sS] | [yY])
            return 0
            ;;
        [nN][oO] | [nN] | "")
            return 1
            ;;
        *)
            warn "Please answer yes or no."
            ;;
        esac
    done
}

log() {
    echo -e "\033[0;32m→ $1\033[0m"
    sleep 0.5
}

warn() {
    echo -e "\033[0;33m! $1\033[0m"
    sleep 0.2
}

error() {
    echo -e "\033[0;31m✗ $1\033[0m"
    sleep 0.2
}

snapper_setup() {
    if sudo snapper list-configs | grep -q "/"; then
        log "Snapper is already setup for /"
        return
    fi

    sudo snapper create-config /
    sudo mkdir -p /var/lib/refind-btrfs
    sudo chmod 755 /var/lib/refind-btrfs
    sudo systemctl enable refind-btrfs --now
}

brew_install() {
    has_cmd brew && return

    log "Installing brew"
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
}

mangowc_install() {
    log "Installing mangowc"

    if is_pikaos; then
        pikman install mangowc
    elif is_fedora && prompt_yn "need terra repository for installing mango. This is NOT stable. Still enable it?"; then
        sudo dnf install --nogpgcheck --repofrompath 'terra,https://repos.fyralabs.com/terra$releasever' terra-release
        sudo dnf install -y mangowc
    else
        error "Unsupported distro"
        return 1
    fi
}

incus_setup() {
    log "Setting up incus"
    sudo usermod -aG incus "$USER"
    sudo usermod -aG incus-admin "$USER"
    sudo systemctl enable --now incus.socket
    sudo incus admin init --minimal
}

flatpaks_install() {
    flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo --user

    local -a flatpaks=(
        com.github.tchx84.Flatseal
        sh.loft.devpod
        org.gnome.Papers
    )

    log "Installing flatpaks(vscode etc)"
    for pkg in "${flatpaks[@]}"; do
        flatpak install -y --user flathub "$pkg"
    done
}

system_packages_install() {
    local -a packages=(
        cmake
        distrobox
        flatpak
        g++
        gcc
        git
        gnome-keyring
        hypridle
        incus
        luarocks
        make
        micro
        mpv
        pass
        qt5ct
        qt6ct
        rclone
        rsync
        snapper
        tar
        tmux
        trash-cli
        tree
        unzip
        virt-manager
        zig
        zsh
        zstd
    )
    local -a pika_pkgs=(
        libsecret-tools
        bibata-cursor-theme
        imagemagick
        nushell
        pika-refind-btrfs-hooks
        refind-btrfs
        snapper-gui
        starship
    )

    if is_pikaos; then
        log "Updating packages"
        sudo apt update && sudo apt upgrade -y
        log "Installing essential packages"
        sudo apt install -y "${packages[@]}" "${pika_pkgs[@]}"
        snapper_setup
    else
        sudo dnf update -y
        sudo dnf copr enable avengemedia/dms
        sudo dnf copr enable solopasha/hyprland
        sudo dnf install -y "${packages[@]}"
        sudo dnf install -y niri dms sddm sddm-themes nu hypridle
        systemctl --user add-wants niri.service dms
    fi

    incus_setup
    flatpaks_install

    brew_install
    brew tap ublue-os/tap
    brew install --cask font-jetbrains-mono-nerd-font font-fontawesome
    brew install pixi

    local -a pixi_pkgs=(
        bash-language-server
        tectonic
        fd
        bat
        bottom
        carapace
        direnv
        duf
        eza
        fzf
        gdu
        gh
        go-gum
        go-shfmt
        jq
        just
        lazygit
        mask
        ripgrep
        shellcheck
        television
        xh
        yazi
        zoxide
    )

    pixi global install "${pixi_pkgs[@]}"
    has_cmd starship || pixi global install starship
}

emacs_install() {
    log "Installing emacs"
    has_cmd pikman && pikman --arch install emacs
    has_cmd dnf && sudo dnf install -y emacs
    git clone --depth 1 https://github.com/doomemacs/doomemacs ~/.config/emacs
    ∙ ~/.config/emacs/bin/doom install
}

rust_install() {
    has_cmd rustup && {
        log "rustup is already installed"
        return
    }

    curl --proto '=https' --tlsv1.2 -fsSL https://sh.rustup.rs | sh
}

nushell_setup() {
    is_pikaos && return

    log "Setting up nushell"
    grep -q "nushell" /etc/shells || {
        echo "/usr/bin/nu" | sudo tee -a /etc/shells
    }
}

devpod_install() {
    has_cmd devpod && {
        log "devpod is already installed"
        return
    }

    log "Installing devpod"
    local devpod_tmp
    devpod_tmp=$(mktemp)
    curl -L -o "$devpod_tmp" "https://github.com/loft-sh/devpod/releases/latest/download/devpod-linux-amd64" &&
        chmod +x "$devpod_tmp" &&
        mv "$devpod_tmp" ~/.local/bin/devpod
    rm -f "$devpod_tmp"
}

astro_install() {
    if dir_exists ~/.config/nvim; then
        prompt_yn "Found existing nvim config. Do you want to trash and replace with AstroNvim?" || return 0
    fi

    trash ~/.config/nvim.bak || true
    mv ~/.config/nvim ~/.config/nvim.bak 2>/dev/null || true
    mkdir ~/.config/nvim 2>/dev/null || true
    mv ~/.local/share/nvim ~/.local/share/nvim.bak 2>/dev/null || true
    mv ~/.local/state/nvim ~/.local/state/nvim.bak 2>/dev/null || true
    mv ~/.cache/nvim ~/.cache/nvim.bak 2>/dev/null || true
    git clone --depth 1 https://github.com/AstroNvim/template ~/.config/nvim
    rm -rf ~/.config/nvim/.git
}

zshrc_setup() {
    log "Setting zsh as default shell"
    chsh -s "$(which zsh)"
}

bashrc_setup() {
    log "Setting up bashrc"
    grep -q "chezmoi/shellrc" ~/.bashrc || {
        echo "source ~/.local/share/chezmoi/shellrc" >>~/.bashrc
    }
}

dotfiles_install() {
    cd || {
        error "Failed to change to home directory"
        return
    }

    log "Setting up dotfiles with chezmoi"
    sh -c "$(curl -fsLS get.chezmoi.io/lb)" -- init --apply https://github.com/pervezfunctor/niri-config.git

    zshrc_setup
    bashrc_setup
    nushell_setup
    astro_install
}

devtools_install() {
    has_cmd mise || {
        curl https://mise.run | sh
    }

    brew install uv mise neovim
    brew install --cask visual-studio-code-linux

    local -a extensions=(
        hverlin.mise-vscode
        jdinhlife.gruvbox
        mads-hartmann.bash-ide-vscode
        TheNuProjectContributors.vscode-nushell-lang
        timonwong.shellcheck
    )

    log "Installing vscode extensions"
    for ext in "${extensions[@]}"; do
        log "Installing $ext"
        code --install-extension "$ext"
    done

    eval "$(~/.local/bin/mise activate bash)"
    mise use -g node@latest

    local -a npm_pkgs=(
        @mermaid-js/mermaid-cli
        @google/gemini-cli
        opencode-ai
    )
    for pkg in "${npm_pkgs[@]}"; do
        log "Installing $pkg"
        npm install -g "$pkg"
    done

    dir_exists ~/jupyter-lab || {
        mkdir -p ~/jupyter-lab
        cd ~/jupyter-lab || {
            error "Failed to change to jupyter-lab directory"
            return
        }
        uv venv --seed
        uv pip install pydantic
        uv pip install jupyterlab
    }

    has_cmd claude || curl -fsSL https://claude.ai/install.sh | bash
    devpod_install
    rust_install
}

zed_install() {
    has_cmd zed && {
        log "zed is already installed"
        return
    }

    log "Installing zed"
    curl -f https://zed.dev/install.sh | sh
}

whiptail_choices() {
    local -a whiptail_items=(
        "system_packages" "Install essential packages" "on"
        "devtools" "Install devtools(vscode, node etc)" "on"
        "dotfiles" "Setup dotfiles with chezmoi" "on"
        "mangowc" "Install mangowc" "off"
        "zed" "Install zed" "off"
        "emacs" "Setup emacs" "off"
    )

    local selected_output
    selected_output=$(whiptail --checklist "Select tasks to execute:" 25 60 19 "${whiptail_items[@]}" 3>&1 1>&2 2>&3)

    local exit_code=$?
    if [ $exit_code -ne 0 ]; then
        warn "Setup cancelled."
        return 1
    fi

    local -a selected_tasks=()
    if [ -n "$selected_output" ]; then
        # Parse space-separated quoted items from whiptail output
        read -ra selected_tasks <<<"$selected_output"
    fi

    if [ ${#selected_tasks[@]} -eq 0 ]; then
        log "No tasks selected."
        return 0
    fi

    for task in "${selected_tasks[@]}"; do
        task=${task//\"/}
        log "Executing: $task"
        "${task}_install"
    done
}

prompts() {
    prompt_yn "Do you want to install essential packages?" && system_packages_install
    prompt_yn "Do you want to setup devtools?" && devtools_install
    prompt_yn "Do you want to setup dotfiles with chezmoi?" && dotfiles_install
    prompt_yn "Do you want to setup mangowc?" && mangowc_install
    prompt_yn "Do you want to install zed?" && zed_install
    prompt_yn "Do you want to setup emacs?" && emacs_install
    prompt_yn "Do you want to setup dotfiles with chezmoi?" && dotfiles_install
}

main() {
    is_pikaos || is_fedora || {
        error "This script is only meant to be run on PikaOS/Fedora"
        return 1
    }

    export PATH="/home/linuxbrew/.linuxbrew/bin:$HOME/bin:$HOME/.local/bin:$PATH"

    mkdir -p ~/Pictures/Screenshots

    if command -v whiptail >/dev/null 2>&1; then
        whiptail_choices || return 1
        return 0
    fi

    prompts
}

main "$@"
