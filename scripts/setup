#!/usr/bin/env bash

has_cmd() {
    command -v "$1" >/dev/null 2>&1
}

dir_exists() {
    [ -d "$1" ]
}

is_pikaos() {
    . /etc/os-release && [ "$ID" = "pika" ]
}

prompt_yn() {
    local prompt="$1"
    local response
    while true; do
        read -rp "\033[0;36m? $prompt\033[0m \033[0;33m[y/N]\033[0m " response
        case "$response" in
        [yY][eE][sS] | [yY])
            return 0
            ;;
        [nN][oO] | [nN] | "")
            return 1
            ;;
        *)
            warn "Please answer yes or no."
            ;;
        esac
    done
}

log() {
    echo -e "\033[0;32m→ $1\033[0m"
}

warn() {
    echo -e "\033[0;33m! $1\033[0m"
}

error() {
    echo -e "\033[0;31m✗ $1\033[0m"
}

system_packages_install() {
    local -a packages=(
        bibata-cursor-theme
        cmake
        distrobox
        flatpak
        g++
        gcc
        git
        gnome-keyring
        imagemagick
        incus
        libsecret-tools
        luarocks
        make
        micro
        mpv
        neovim
        nushell
        pass
        pika-refind-btrfs-hooks
        qt5ct
        qt6ct
        rclone
        refind-btrfs
        rsync
        snapper
        snapper-gui
        starship
        tar
        tmux
        trash-cli
        tree
        unzip
        virt-manager
        zig
        zsh
        zstd
    )

    log "Updating packages"
    sudo apt update && sudo apt upgrade -y

    log "Installing essential packages"
    sudo apt install -y "${packages[@]}"

    flatpaks_install
    snapper_install
    incus_install
}

mangowc_install() {
    log "Installing mangowc and dms"
    pikman install mangowc dms
}

incus_install() {
    log "Setting up incus"
    sudo usermod -aG incus "$USER"
    sudo usermod -aG incus-admin "$USER"
    sudo systemctl enable --now incus.socket
    sudo incus admin init --minimal
}

flatpaks_install() {
    flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo --user

    local -a flatpaks=(
        com.github.tchx84.Flatseal
        sh.loft.devpod
        org.gnome.Papers
    )

    log "Installing flatpaks(vscode etc)"
    for pkg in "${flatpaks[@]}"; do
        flatpak install -y --user flathub "$pkg"
    done
}

emacs_install() {
    log "Installing emacs"
    pikman --arch install emacs
    git clone --depth 1 https://github.com/doomemacs/doomemacs ~/.config/emacs
    ∙ ~/.config/emacs/bin/doom install
}

rust_install() {
    has_cmd rustup && {
        log "rustup is already installed"
        return
    }

    curl --proto '=https' --tlsv1.2 -fsSL https://sh.rustup.rs | sh
}

nushell_install() {
    log "Setting up nushell"
    grep -q "nushell" /etc/shells || {
        echo "/usr/bin/nu" | sudo tee -a /etc/shells
    }
    chsh -s /usr/bin/nu "$USER"
}

devpod_install() {
    has_cmd devpod && {
        log "devpod is already installed"
        return
    }

    log "Installing devpod"
    local devpod_tmp
    devpod_tmp=$(mktemp)
    curl -L -o "$devpod_tmp" "https://github.com/loft-sh/devpod/releases/latest/download/devpod-linux-amd64" &&
        chmod +x "$devpod_tmp" &&
        mv "$devpod_tmp" ~/.local/bin/devpod
    rm -f "$devpod_tmp"
}

astro_install() {
    if dir_exists ~/.config/nvim; then
        prompt_yn "Found existing nvim config. Do you want to trash and replace with AstroNvim?" || return 0
    fi

    trash ~/.config/nvim.bak || true
    mv ~/.config/nvim ~/.config/nvim.bak 2>/dev/null || true
    mkdir ~/.config/nvim 2>/dev/null || true
    mv ~/.local/share/nvim ~/.local/share/nvim.bak 2>/dev/null || true
    mv ~/.local/state/nvim ~/.local/state/nvim.bak 2>/dev/null || true
    mv ~/.cache/nvim ~/.cache/nvim.bak 2>/dev/null || true
    git clone --depth 1 https://github.com/AstroNvim/template ~/.config/nvim
    rm -rf ~/.config/nvim/.git
}

zshrc_install() {
    log "Setting zsh as default shell"
    chsh -s "$(which zsh)"
}

bashrc_install() {
    log "Setting up bashrc"
    grep -q "chezmoi/shellrc" ~/.bashrc || {
        echo "source ~/.local/share/chezmoi/shellrc" >>~/.bashrc
    }
}

dotfiles_install() {
    cd || {
        error "Failed to change to home directory"
        return
    }

    log "Setting up dotfiles with chezmoi"
    sh -c "$(curl -fsLS get.chezmoi.io/lb)" -- init --apply https://github.com/pervezfunctor/chezmoi.git

    zshrc_install
    bashrc_install
    nushell_install
    astro_install
}

devtools_install() {
    has_cmd mise || {
        curl https://mise.run | sh
    }

    eval "$(~/.local/bin/mise activate bash)"

    mise use -g pixi node@latest uv

    local -a npm_pkgs=(
        @mermaid-js/mermaid-cli
        @google/gemini-cli
        opencode-ai
    )
    for pkg in "${npm_pkgs[@]}"; do
        log "Installing $pkg"
        npm install -g "$pkg"
    done

    local -a pixi_pkgs=(
        bash-language-server
        tectonic
        fd
        bat
        bottom
        carapace
        direnv
        duf
        eza
        fzf
        gdu
        gh
        go-gum
        go-shfmt
        jq
        just
        lazygit
        mask
        ripgrep
        shellcheck
        television
        xh
        yazi
        zoxide
    )

    pixi global install "${pixi_pkgs[@]}"

    dir_exists ~/jupyter-lab || {
        mkdir -p ~/jupyter-lab
        cd ~/jupyter-lab || {
            error "Failed to change to jupyter-lab directory"
            return
        }
        uv venv --seed
        uv pip install pydantic
        uv pip install jupyterlab
    }

    has_cmd claude || curl -fsSL https://claude.ai/install.sh | bash
    devpod_install
    vscode_install
}

zed_install() {
    has_cmd zed && {
        log "zed is already installed"
        return
    }

    log "Installing zed"
    curl -f https://zed.dev/install.sh | sh
}

snapper_install() {
    if sudo snapper list-configs | grep -q "/"; then
        log "Snapper is already setup for /"
        return
    fi

    sudo snapper create-config /
    sudo mkdir -p /var/lib/refind-btrfs
    sudo chmod 755 /var/lib/refind-btrfs
    sudo systemctl enable refind-btrfs --now
}

brew_install() {
    has_cmd brew || {
        log "Installing brew"
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
    }
    brew tap ublue-os/tap
}

vscode_install() {
    has_cmd code && {
        log "vscode is already installed"
        return
    }

    brew_install

    brew install --cask visual-studio-code-linux

    local -a vscode_exts=(
        hverlin.mise-vscode
        jdinhlife.gruvbox
        mads-hartmann.bash-ide-vscode
        TheNuProjectContributors.vscode-nushell-lang
        timonwong.shellcheck
    )

    log "Installing vscode extensions"
    for ext in "${vscode_exts[@]}"; do
        log "Installing $ext"
        code --install-extension "$ext"
    done
}

whiptail_choices() {
    local -a whiptail_items=(
        "system_packages" "Install essential packages" "on"
        "devtools" "Install devtools(vscode, node etc)" "on"
        "dotfiles" "Setup dotfiles with chezmoi" "on"
        "mangowc" "Install mangowc" "off"
        "zed" "Install zed" "off"
        "emacs" "Setup emacs" "off"
    )

    local selected_output
    selected_output=$(whiptail --checklist "Select tasks to execute:" 25 60 19 "${whiptail_items[@]}" 3>&1 1>&2 2>&3)

    local exit_code=$?
    if [ $exit_code -ne 0 ]; then
        warn "Setup cancelled."
        return 1
    fi

    local -a selected_tasks=()
    if [ -n "$selected_output" ]; then
        # Parse space-separated quoted items from whiptail output
        read -ra selected_tasks <<<"$selected_output"
    fi

    if [ ${#selected_tasks[@]} -eq 0 ]; then
        log "No tasks selected."
        return 0
    fi

    for task in "${selected_tasks[@]}"; do
        task=${task//\"/}
        log "Executing: $task"
        "${task}_install"
    done
}

main() {
    is_pikaos || {
        error "This script is only meant to be run on PikaOS"
        return 1
    }

    export PATH="$HOME/.opencode/bin:$PATH:$HOME/bin:$HOME/.local/bin:$PATH"

    mkdir -p ~/Pictures/Screenshots

    if command -v whiptail >/dev/null 2>&1; then
        whiptail_choices || return 1
        return 0
    fi

    prompt_yn "Do you want to install essential packages?" && system_packages_install
    prompt_yn "Do you want to setup devtools?" && devtools_install
    prompt_yn "Do you want to setup dotfiles with chezmoi?" && dotfiles_install
    prompt_yn "Do you want to setup mangowc?" && mangowc_install
    prompt_yn "Do you want to install zed?" && zed_install
    prompt_yn "Do you want to setup emacs?" && emacs_install

    if ! prompt_yn "Do you want to setup dotfiles with chezmoi?"; then
        return 0
    fi

    dotfiles_install
}

main "$@"
