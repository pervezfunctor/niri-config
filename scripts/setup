#!/usr/bin/env bash

has_cmd() {
    command -v "$1" >/dev/null 2>&1
}

prompt_yn() {
    local prompt="$1"
    local response
    while true; do
        read -rp "\033[0;36m? $prompt\033[0m \033[0;33m[y/N]\033[0m " response
        case "$response" in
        [yY][eE][sS] | [yY])
            return 0
            ;;
        [nN][oO] | [nN] | "")
            return 1
            ;;
        *)
            warn "Please answer yes or no."
            ;;
        esac
    done
}

log() {
    echo -e "\033[0;32m→ $1\033[0m"
}

warn() {
    echo -e "\033[0;33m! $1\033[0m"
}

error() {
    echo -e "\033[0;31m✗ $1\033[0m"
}

system_packages_install() {
    local -a packages=(
        bat
        btm
        carapace
        cmake
        direnv
        distrobox
        duf
        eza
        fd-find
        fzf
        gcc
        gdu
        gh
        git
        git-delta
        gnome-keyring
        gum
        htop
        imagemagick
        incus
        jq
        just
        lazygit
        libsecret-tools
        luarocks
        make
        micro
        mpv
        neovim
        node-mermaid
        nushell
        papers
        pass
        pika-refind-btrfs-hooks
        rclone
        refind-btrfs
        ripgrep
        rsync
        shellcheck
        shfmt
        snapper
        snapper-gui
        starship
        tar
        tmux
        trash-cli
        tree
        tree-sitter-cli
        unzip
        virt-manager
        xh
        yazi
        zig
        zoxide
        zsh
        zstd
    )

    log "Updating packages"
    pikman update && pikman upgrade

    log "Installing essential packages"
    pikman install "${packages[@]}"
}

mangowc_install() {
    log "Installing mangowc and dms"
    pikman install mangowc dms
}

incus_install() {
    log "Setting up incus"
    sudo usermod -aG incus "$USER"
    sudo usermod -aG incus-admin "$USER"
    sudo systemctl enable --now incus.socket
    sudo incus admin init --minimal
}

flatpaks_install() {
    local -a flatpaks=(
        com.github.tchx84.Flatseal
        sh.loft.devpod
    )

    log "Installing flatpaks(vscode etc)"
    for flatpak in "${flatpaks[@]}"; do
        pikman --flatpak install flathub "$flatpak"
    done
}

rust_install() {
    has_cmd rustup && {
        log "rustup is already installed"
        return
    }

    curl --proto '=https' --tlsv1.2 -fsSL https://sh.rustup.rs | sh
}

nushell_install() {
    log "Setting up nushell"
    grep -q "nushell" /etc/shells || {
        echo "/usr/bin/nu" | sudo tee -a /etc/shells
    }
    chsh -s /usr/bin/nu "$USER"
}

vscode-extensions_install() {
    has_cmd code || {
        error "vscode is not installed, cannot install extensions"
        return
    }

    local -a vscode_exts=(
        jdinhlife.gruvbox
        mads-hartmann.bash-ide-vscode
        timonwong.shellcheck
    )

    log "Installing vscode extensions"
    for ext in "${vscode_exts[@]}"; do
        log "Installing $ext"
        code --install-extension "$ext"
    done
}

devpod_install() {
    has_cmd devpod && {
        log "devpod is already installed"
        return
    }

    log "Installing devpod"
    local devpod_tmp
    devpod_tmp=$(mktemp)
    curl -L -o "$devpod_tmp" "https://github.com/loft-sh/devpod/releases/latest/download/devpod-linux-amd64" &&
        chmod +x "$devpod_tmp" &&
        mv "$devpod_tmp" ~/.local/bin/devpod
    rm -f "$devpod_tmp"
}

chezmoi_install() {
    cd || {
        error "Failed to change to home directory"
        return
    }

    log "Setting up dotfiles with chezmoi"
    sh -c "$(curl -fsLS get.chezmoi.io/lb)" -- init --apply https://github.com/pervezfunctor/pikman-niri-config.git
}

zshrc_install() {
    log "Setting zsh as default shell"
    chsh -s "$(which zsh)"
}

bashrc_install() {
    log "Setting up bashrc"
    grep -q "chezmoi/shellrc" ~/.bashrc || {
        echo "source ~/.local/share/chezmoi/shellrc" >>~/.bashrc
    }
}

mise_install() {
    has_cmd mise && {
        log "mise is already installed"
        return
    }

    curl https://mise.run | sh
}

zed_install() {
    has_cmd zed && {
        log "zed is already installed"
        return
    }

    log "Installing zed"
    curl -f https://zed.dev/install.sh | sh
}

astro_install() {
    trash ~/.config/nvim.bak || true
    mv ~/.config/nvim ~/.config/nvim.bak || true
    mkdir ~/.config/nvim || true
    mv ~/.local/share/nvim ~/.local/share/nvim.bak || true
    mv ~/.local/state/nvim ~/.local/state/nvim.bak || true
    mv ~/.cache/nvim ~/.cache/nvim.bak || true
    git clone --depth 1 https://github.com/AstroNvim/template ~/.config/nvim
    rm -rf ~/.config/nvim/.git
}

snapper_install() {
    if sudo snapper list-configs | grep -q "/"; then
        log "Snapper is already setup for /"
        return
    fi

    sudo snapper create-config /
    sudo mkdir -p /var/lib/refind-btrfs
    sudo chmod 755 /var/lib/refind-btrfs
    sudo systemctl enable refind-btrfs --now
}

uv_install() {
    has_cmd uv || {
        log "Installing uv"
        curl -LsSf https://astral.sh/uv/install.sh | sh
    }

    mkdir -p ~/jupyter-lab
    cd ~/jupyter-lab || {
        error "Failed to change to jupyter-lab directory"
        return
    }
    uv venv --seed
    uv pip install pydantic
    uv pip install jupyterlab

    cd || {
        warn "Failed to change to home directory"
        return
    }
}

claude_install() {
    has_cmd claude && {
        log "claude is already installed"
        return
    }
    curl -fsSL https://claude.ai/install.sh | bash
}

brew_install() {
    has_cmd brew && {
        log "brew is already installed"
        return
    }

    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"

    brew tap ublue-os/tap
    brew install --cask visual-studio-code-linux
    brew install bash-language-server @google/gemini-cli opencode-ai tectonic
}

volta_install() {
    has_cmd volta && {
        log "volta is already installed"
        return
    }

    curl https://get.volta.sh | bash

    log "To install node with volta:"
    log "\tvolta install node@latest"
}

dialog_choices() {
    local -a dialog_items=(
        "system_packages" "Install essential packages" "on"
        "flatpaks" "Install flatpaks" "on"
        "brew" "Install brew" "on"
        "snapper" "Setup snapper(btrfs snapshots)" "on"
        "chezmoi" "Setup dotfiles with chezmoi" "on"
        "bashrc" "Set up bashrc" "on"
        "zshrc" "Set zsh as default shell" "on"
        "nushell" "Setup nushell" "on"
        "incus" "Setup incus" "on"
        "devpod" "Setup devpod" "on"
        "volta" "Install volta" "on"
        "zed" "Install zed" "off"
        "astro" "Setup astro(nvim)" "off"
        "rust" "Install rust" "off"
        "uv" "Install uv" "off"
        "claude" "Install claude" "off"
        "vscode-extensions" "Install vscode extensions" "off"
        "mangowc" "Setup mangowc" "off"
        "mise" "Setup mise" "off"
    )

    local selected_output
    selected_output=$(dialog --stdout --checklist "Select tasks to execute:" 25 60 19 "${dialog_items[@]}")

    local exit_code=$?
    if [ $exit_code -ne 0 ]; then
        warn "Setup cancelled."
        return 1
    fi

    local -a selected_tasks=()
    if [ -n "$selected_output" ]; then
        mapfile -t selected_tasks <<<"$selected_output"
    fi

    if [ ${#selected_tasks[@]} -eq 0 ]; then
        log "No tasks selected."
        return 0
    fi

    for task in "${selected_tasks[@]}"; do
        task=${task//\"/}
        log "Executing: $task"
        $task
    done
}

main() {
    export PATH="$HOME/.opencode/bin:$PATH:$HOME/bin:$HOME/.local/bin:$PATH"

    mkdir -p ~/Pictures/Screenshots

    if command -v dialog >/dev/null 2>&1; then
        dialog_choices || return 1
        return 0
    fi

    prompt_yn "Do you want to install essential packages?" && system_packages_install
    prompt_yn "Do you want to install flatpaks?" && flatpaks_install
    prompt_yn "Do you want to install brew?" && brew_install
    prompt_yn "Do you want to install volta?" && volta_install
    prompt_yn "Do you want to setup snapper(btrfs snapshots)?" && snapper_install
    prompt_yn "Do you want to install zed?" && zed_install
    prompt_yn "Do you want to setup astro(nvim)?" && astro_install
    prompt_yn "Do you want to install rust?" && rust_install
    prompt_yn "Do you want to install uv?" && uv_install
    prompt_yn "Do you want to install claude?" && claude_install
    prompt_yn "Do you want to install vscode extensions?" && vscode-extensions_install
    prompt_yn "Do you want to setup incus?" && incus_install
    prompt_yn "Do you want to setup mangowc?" && mangowc_install
    prompt_yn "Do you want to setup devpod?" && devpod_install
    prompt_yn "Do you want to setup mise?" && mise_install

    if ! prompt_yn "Do you want to setup dotfiles with chezmoi?"; then
        return 0
    fi

    chezmoi_install

    prompt_yn "Do you want to set up bashrc?" && bashrc_install
    prompt_yn "Do you want to set zsh as default shell?" && zshrc_install
    prompt_yn "Do you want to setup nushell as default shell?" && nushell_install
}

main "$@"
